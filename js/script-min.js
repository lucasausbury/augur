function book_details(){var t=augur.chart.getSelection()[0];if(t){var e=augur.data.getValue(t.row,t.column);$.ajax({url:"book/",data:{categories:augur.cats,salesRank:e},type:"post",cache:!0,error:function(t,e){alert(t.responseText)},success:function(t){$("#book_modal .modal-content").html(t),$("#book_modal").modal("show")}})}}function print_stats(t){var e=$("#stats"),a=$('<p class="lead" />'),i=t.map(function(t,e){return t[0]}),n=i.reduce(function(t,e){return t+e}),r=t.map(function(t,e){return t[1]}),o=r.reduce(function(t,e){return t+e});e.html(""),a.append("Average price: $"+(i.length/n).toFixed(2)+"<br />"),a.append("Median price: $"+median(i).toFixed(2)+"<br />"),a.append("Most successful price: $"+i[array_min(r)].toFixed(2)+"<br />"),a.append("Least successful price: $"+i[array_max(r)].toFixed(2)+"<br />"),a.append("Median sales rank: "+median(r).toFixed().replace(/(\d)(?=(\d{3})+(,|$))/g,"$1,")+"<br />"),e.append(a)}function array_max(t){for(var e=t[0],a=0,i=1;i<t.length;i++)t[i]>e&&(a=i,e=t[i]);return a}function array_min(t){for(var e=t[0],a=0,i=1;i<t.length;i++)t[i]<e&&t[i]>0&&(a=i,e=t[i]);return a}function median(t){if(t.sort(function(t,e){return t-e}),0===t.length)return 0;var e=Math.floor(t.length/2);return t.length%2?t[e]:(t[e-1]+t[e])/2}function get_feed(t,e){augur.cats=t,void 0===t&&(t=[]),void 0===e&&(e=function(){});var a={};a.categories=t,$.ajax({url:"feed/",data:a,type:"post",cache:!0,error:function(t,e){alert(t.responseText)},success:function(t){e(t)}})}function isAction(t){return"function"==typeof window[t]}augur={},treemap=new function(){this.defaults={margin:{top:24,right:0,bottom:0,left:0},rootname:"TOP",format:",f",title:"",width:960,height:500},this.init=function(t,e,a){this.root=null,this.id=t,this.$elem=$("#"+t),this.opts=$.extend(!0,{},this.defaults,a),this.formatNumber=d3.format(this.opts.format),this.rname=this.opts.rootname,this.margin=this.opts.margin,this.theight=52,this.opts.width="auto"==this.opts.width?this.$elem[0].offsetWidth-25:this.defaults.width,this.$elem.width(this.opts.width).height(this.opts.height),this.width=this.opts.width-this.margin.left-this.margin.right,this.height=this.opts.height-this.margin.top-this.margin.bottom-this.theight,this.transitioning=!1,this.color=d3.scale.category20c(),this.x=d3.scale.linear().domain([0,this.width]).range([0,this.width]),this.y=d3.scale.linear().domain([0,this.height]).range([0,this.height]),this.treemap=d3.layout.treemap().children(function(t,e){return e?null:t._children}).sort(function(t,e){return t.value-e.value}).ratio(this.height/this.width*.5*(1+Math.sqrt(5))).round(!1),this.svg=d3.select("#"+this.id).append("svg").attr("width",this.width+this.margin.left+this.margin.right).attr("height",this.height+this.margin.bottom+this.margin.top).style("margin-left",-this.margin.left+"px").style("margin-right",-this.margin.right+"px").append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")").style("shape-rendering","crispEdges"),this.grandparent=this.svg.append("g").attr("class","grandparent"),this.grandparent.append("rect").attr("y",-this.margin.top).attr("width",this.width).attr("height",this.margin.top),this.grandparent.append("text").attr("x",6).attr("y",6-this.margin.top).attr("dy",".75em"),this.opts.title&&this.$elem.prepend('<p class="title">'+this.opts.title+"</p>"),e instanceof Array?this.root={name:this.rname,children:e}:this.root=e,this.root.x=0,this.root.y=0,this.root.dx=this.width,this.root.dy=this.height,this.depth=0,this.accumulate(this.root),this.layout(this.root),this.display(this.root)},this.accumulate=function(t){var e=this;return t.children&&t.children.length>0&&(t._children=t.children.slice(0),t.value=t.children.reduce(function(t,a){return isNaN(t)?0:t+e.accumulate(a)},0)),t.books},this.layout=function(t){var e=this;t._children&&(e.treemap.nodes({_children:t._children}),t._children.forEach(function(a){a.x=t.x+a.x*t.dx,a.y=t.y+a.y*t.dy,a.dx*=t.dx,a.dy*=t.dy,a.parent=t,e.layout(a)}))},this.display=function(t){function e(t){var a="";return t.parent?a+=e(t.parent):t.name.length>0&&(a+=","+t.name),a}function a(t){get_feed(e(t).substr(1).split(","),function(e){print_stats(e.books.slice(0)),e.books.unshift(["Price","Sales rank"]),augur.data=google.visualization.arrayToDataTable(e.books),augur.chart.draw(augur.data,augur.options),n(t)}),n(t)}function i(t,a){var i=e(t).substr(1)+","+t.name;i=i.split(","),t.children?n(t):get_feed(i,function(e){print_stats(e.books.slice(0)),t.children=e.categories,e.books.unshift(["Price","Sales rank"]),augur.data=google.visualization.arrayToDataTable(e.books),augur.chart.draw(augur.data,augur.options),c.accumulate(t),c.layout(t),n(t)})}function n(t){if(!c.transitioning&&t){c.transitioning=!0;var e=c.display(t),a=u.transition().duration(750),i=e.transition().duration(750);c.x.domain([t.x,t.x+t.dx]),c.y.domain([t.y,t.y+t.dy]),c.svg.style("shape-rendering",null),c.svg.selectAll(".depth").sort(function(t,e){return t.depth-e.depth}),e.selectAll("text").style("fill-opacity",0),a.selectAll(".ptext").call(r).style("fill-opacity",0),a.selectAll(".ctext").call(o).style("fill-opacity",0),i.selectAll(".ptext").call(r).style("fill-opacity",1),i.selectAll(".ctext").call(o).style("fill-opacity",1),a.selectAll("rect").call(s),i.selectAll("rect").call(s),a.remove().each("end",function(){c.svg.style("shape-rendering","crispEdges"),c.transitioning=!1})}}function r(t){t.selectAll("tspan").attr("x",function(t){return c.x(t.x)+6}),t.attr("x",function(t){return c.x(t.x)+6}).attr("y",function(t){return c.y(t.y)+6}).style("opacity",function(t){return this.getComputedTextLength()<c.x(t.x+t.dx)?1:0})}function o(t){t.attr("x",function(t){return c.x(t.x+t.dx)-this.getComputedTextLength()-6}).attr("y",function(t){return c.y(t.y+t.dy)-6}).style("opacity",function(t){return this.getComputedTextLength(),c.x(t.x+t.dx),c.x(t.x),0})}function s(t){t.attr("x",function(t){return c.x(t.x)}).attr("y",function(t){return c.y(t.y)}).attr("width",function(t){return c.x(t.x+t.dx)-c.x(t.x)}).attr("height",function(t){return c.y(t.y+t.dy)-c.y(t.y)})}function l(t){return t.parent?l(t.parent)+" > "+t.name+" ("+c.formatNumber(t.value)+")":t.name+" ("+c.formatNumber(t.value)+")"}var c=this,u,h,d,g;return this.grandparent.datum(t.parent).on("click",a).select("text").text(l(t)),u=this.svg.insert("g",".grandparent").datum(t).attr("class","depth"),h=u.selectAll("g").data(t._children).enter().append("g"),h.filter(function(t){return t._children}).classed("children",!0).on("click",i),d=h.selectAll(".child").data(function(t){return t._children||[t]}).enter().append("g"),d.append("rect").attr("class","child").call(s).append("title").text(function(t){var e=t.parent;return e.name+" ("+c.formatNumber(e.value)+")"}),d.append("text").attr("class","ctext").text(function(t){return t.name}).call(o),h.append("rect").attr("class","parent").call(s),g=h.append("text").attr("class","ptext").attr("dy",".75em"),g.append("tspan").text(function(t){return t.name}),h.selectAll("rect").style("fill",function(t){return c.color(t.name)}),h}},d3.json("data/categories.json",function(t,e){t||treemap.init("treemap",e,{name:"Books",children:e,width:"auto"})}),get_feed(["Books"],function(t){function e(){augur.data=google.visualization.arrayToDataTable(t.books),augur.options={hAxis:{title:"Price",minValue:0,format:"currency",logScale:!0},vAxis:{title:"Sales rank",minValue:0,direction:-1,format:"long",logScale:!0},legend:"none",dataOpacity:.1},augur.chart=new google.visualization.ScatterChart(document.getElementById("scatter")),augur.chart.draw(augur.data,augur.options),google.visualization.events.addListener(augur.chart,"select",book_details)}print_stats(t.books.slice(0)),t.books.unshift(["Price","Sales rank"]),google.charts.load("current",{packages:["corechart"]}),google.charts.setOnLoadCallback(e)}),$(document).ready(function(){$(document).trigger("hashchange")}),$("#log").on("click",function(t){$(this).is(":checked")?(augur.options.hAxis.logScale=!0,augur.options.vAxis.logScale=!0,augur.options.dataOpacity=.1):(augur.options.hAxis.logScale=!1,augur.options.vAxis.logScale=!1,augur.options.dataOpacity=.05),augur.chart.draw(augur.data,augur.options)}),$(document).on("hashchange",function(t){var e=window.location.hash.substring(1);isAction(e)&&window[e]($(this),t)}),$(document).on("click",'a[href^="#"]',function(t){var e=$(this).attr("href").substring(1);isAction(e)&&(t.preventDefault(),window[e]($(this),t))});